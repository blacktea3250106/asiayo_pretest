
# 題目一

請寫出一條查詢語句 (SQL)，列出在 2023 年 5 月下訂的訂單，使用台幣付款且 5 月總金額最多的前 10 筆的旅宿 ID (`bnb_id`)、旅宿名稱 (`bnb_name`)、5 月總金額 (`may_amount`)。

## 答案

```sql
SELECT
    o.bnb_id,
    b.bnb_name,
    SUM(o.amount) AS may_amount
FROM
    orders o
INNER JOIN
    bnb b ON o.bnb_id = b.bnb_id
WHERE
    o.order_date >= '2023-05-01'
    AND o.order_date < '2023-06-01'
    AND o.currency = 'TWD'
GROUP BY
    o.bnb_id,
    b.bnb_name
ORDER BY
    may_amount DESC
LIMIT 10;
```

**解釋：**

- **INNER JOIN**：將 `orders` 表與 `bnb` 表進行內連接，獲取對應的旅宿名稱。
- **日期篩選**：使用 `order_date` 篩選出 2023 年 5 月的訂單，確保查詢範圍精確。
- **貨幣過濾**：只選取使用台幣付款的訂單，確保金額的統計一致性。
- **分組與排序**：根據 `bnb_id` 和 `bnb_name` 分組，計算每個旅宿的總金額，並按照總金額降序排序。
- **限制結果**：使用 `LIMIT 10` 取得金額最高的前 10 筆記錄。

# 題目二

在題目一的執行下，我們發現 SQL 執行速度很慢，您會怎麼去優化？請闡述您怎麼判斷與優化的方式。

## 答案

### 判斷問題的方法

1. **分析執行計劃**

   - 使用 `EXPLAIN` 關鍵字查看查詢的執行計劃，檢查是否有全表掃描或索引未被使用的情況。
   - 確認每個步驟的預估成本，找出耗時的操作。

2. **檢查索引**

   - 查看 `orders` 表是否對 `order_date`、`currency` 和 `bnb_id` 建立了適當的索引。
   - 確認 `bnb` 表的 `bnb_id` 是否有索引，以優化 JOIN 操作。

3. **監控系統資源**

   - 使用數據庫的性能監控工具，觀察 CPU、內存、磁盤 I/O 的使用情況，判斷是否存在資源瓶頸。

4. **數據量分析**

   - 評估 `orders` 表在 5 月份的數據量，確定是否需要進行數據分區或優化。

### 優化的方式

1. **建立適當的索引**

   - **單列索引**：
     - 在 `orders` 表的 `order_date` 上建立索引，加速日期範圍查詢。
     - 在 `currency` 字段上建立索引，優化貨幣類型的過濾。
   - **複合索引**：
     - 建立 `(currency, order_date, bnb_id)` 的複合索引，提高查詢效率。
     - 注意索引列的順序應根據查詢條件的使用頻率和選擇性來決定。

2. **優化查詢語句**

   - **避免不必要的字段**：只選取需要的字段，減少數據傳輸量。
   - **簡化 GROUP BY**：如果 `bnb_name` 不需要分組，可以僅對 `bnb_id` 進行分組，然後在 SELECT 子句中使用子查詢獲取 `bnb_name`。

3. **數據庫參數調整**

   - 增加 `innodb_buffer_pool_size`（如果使用的是 MySQL），提高數據庫的緩存能力。
   - 調整 `join_buffer_size`、`sort_buffer_size` 等參數，優化排序和連接操作。

4. **使用表分區**

   - **時間分區**：按照 `order_date` 對 `orders` 表進行分區，縮小查詢掃描的範圍。
   - **按區查詢**：確保查詢能夠命中特定的分區，進一步提高效率。

5. **預計算與緩存**

   - **預計算統計數據**：將月度統計結果定期計算並存儲，查詢時直接獲取結果。
   - **應用層緩存**：使用 Redis 等緩存查詢結果，減少對數據庫的壓力。

6. **硬件升級**

   - **提升磁盤性能**：使用 SSD 替換傳統硬盤，減少磁盤讀寫延遲。
   - **增加內存容量**：提高內存，讓更多的數據和索引駐留在內存中。

7. **數據庫讀寫分離**

   - 部署主從數據庫，將讀操作分配到從庫，減輕主庫壓力。
